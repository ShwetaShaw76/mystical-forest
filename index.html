<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-animation-mixer@6.0.0/dist/aframe-animation-mixer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mystic Forest</title>
</head>
<body>

<a-scene background="color:#87CEEB" 
         environment="preset: forest; skyType: gradient; skyColor: #0b0d33; horizonColor: #1a1a2e; groundTexture: grass; groundColor: #5CAC2D;" physics="gravity: -9.8" physics-debug="true" character-interaction>

        

    <a-assets>
        <a-asset-item id="tree" src="./maple_tree/scene.gltf"></a-asset-item>
        <a-asset-item id="cyclizar" src="./pokemon_dragapult/scene.gltf"></a-asset-item>
        <a-asset-item id="raboot" src="./shiny_raboot_official/scene.gltf"></a-asset-item>
        <a-asset-item id="tent" src="./tent_20_mb/scene.gltf"></a-asset-item>
        <a-asset-item id="campire" src="./cozy_campfire_-_shape_key_animation/scene.gltf"></a-asset-item>
        <a-asset-item id="lowPolyHand" src="https://cdn.jsdelivr.net/gh/aframevr/aframe-hand-models@master/models/low-poly-hand.glb"></a-asset-item>
        <a-asset-item id="lowPolyHandLeft" src="https://cdn.jsdelivr.net/gh/aframevr/aframe-hand-models@master/models/low-poly-hand-left.glb"></a-asset-item>
        <a-asset-item id="lowPolyHandRight" src="https://cdn.jsdelivr.net/gh/aframevr/aframe-hand-models@master/models/low-poly-hand-right.glb"></a-asset-item>
        <a-asset-item id="table" src="./table_and_chairs/scene.gltf"></a-asset-item>
        <a-asset-item id="pot" src="./pot/scene.gltf"></a-asset-item>
        <a-asset-item id="mushroomModel" src="./stylized_mushrooms.glb"></a-asset-item>
        <a-asset-item id="treeanimated" src="./pine_tree/scene.gltf"></a-asset-item>
        <a-asset-item id="thorns" src="./tree/scene.gltf"></a-asset-item>
    </a-assets>

    <a-light type="ambient" color="#222" intensity="0.3"></a-light>
    <a-light type="directional" color="#88aaff" intensity="0.3" position="-1 1 2"></a-light>

    
    <a-entity hand-controls="hand: right; handModelStyle: lowPoly; color: #ffcccc"></a-entity>
    <a-entity hand-controls="hand: left; handModelStyle: lowPoly; color: #ccffcc"></a-entity>

    <a-entity gltf-model="#tree" position="1 -0.3 -3" scale="0.2 0.2 0.2"></a-entity>

    <a-entity id="yraboot"
    gltf-model="#raboot" 
    position="10 0.3 12" 
    scale="1 1 1"
    animation-mixer="clip:pm0955_00_00_00011_defaultidle02; loop: repeat;"
    dynamic-body></a-entity>
    <a-entity rotation="0 0 0" position="0 0 0">
    <a-entity id="ycyclizar"
    gltf-model="#cyclizar" 
    position="15 0.5 12" 
    scale="5 5 5" 
    animation-mixer=" clip :Armature|Armature|pm0887_00_00_ba10_waitA01|Base Layer; loop: repeat;"
    dragapult-interaction
    dynamic-body>
    </a-entity>
    </a-entity>

    <a-entity
    gltf-model="#tent"
    position="14 0 -10"
    scale="2 2 2"
    static-body></a-entity>
    <a-entity id="sleepButton" position="14 1 -10" sleep-button>
      <a-plane width="1.5" height="0.6" color="#333" class="clickable">
        <a-text value=" Sleep " align="center" color="#fff" width="4" position="0 0 0.01"></a-text>
      </a-plane>
    </a-entity>

    <a-entity id="rig" movement-controls kinematic-body="radius:0.3; height:1.6" position="0 1.6 0" rotation-reader>
  
  
  <a-entity 
    camera 
    look-controls
    position="0 1.2 0"
    cursor="fuse: false; rayOrigin: mouse"
    raycaster="objects: .clickable">

   
    <a-entity id="fadeScreen"
              geometry="primitive: plane; height: 3; width: 3"
              material="color: black; opacity: 0"
              position="0 0 -0.5"
              visible="true">
    </a-entity>
  </a-entity>
</a-entity>

    <a-entity id="campfire"
    gltf-model="#campire"
    position="-10 0.2 9.5"
    scale="0.6 0.6 0.6"
    animation-mixer="clip:*; loop: repeat"
    static-body></a-entity>
    <a-entity id="sitButton" position="-10 2 12.5" sit-button>
  <a-plane 
    width="1.5" 
    height="0.6" 
    color="#333" 
    material="side: double" 
    class="clickable">
    <a-text 
    value="Sit" 
    align="center" 
    color="#fff" 
    width="2" 
    position="0 0 0.1" />
  </a-plane>
  
</a-entity>
    <a-light type="point" 
         position="-10 1 12.5" 
         intensity="2" 
         distance="15" 
         color="orange">
    </a-light>
    <a-entity
    gltf-model="#table"
    position="0 0 17"
    scale="2.5 2.5 2.5"
    static-body></a-entity>
    <a-entity
    gltf-model="#pot"
    position="0 2 17"
    scale="0.7 0.7 0.7"
    static-body></a-entity>
</a-entity>

    <a-entity proximity-spawner="model: #mushroomModel; count: 80; radius: 40; scaleMin: 0.3; scaleMax: 0.5; emissive: random;"></a-entity>
    <a-entity proximity-spawner="model: #treeanimated; count: 20; radius: 60; scaleMin: 0.4; scaleMax: 0.8;"></a-entity>
    <a-entity proximity-spawner="model: #thorns; count: 20; radius: 35; emissive: green;"></a-entity>

</a-scene>

<script>
AFRAME.registerComponent('character-interaction', {
  schema: {
    distance: { type: 'number', default: 3 },
    followSpeed: { type: 'number', default: 0.0025 },
    interactDistance: { type: 'number', default: 4 } 
  },

  init: function () {
    this.player = document.querySelector('#rig');
    this.raboot = document.querySelector('#yraboot');

    this.following = false;
    this.groundY = this.raboot.object3D.position.y;
    this.isWalking = false;
    this.isPlayingTempAnim = false;

    this.setRabootAni('pm0955_00_00_00011_defaultidle02', true);

    window.addEventListener('keydown', (e) => this.onKeyDown(e));
  },

  onKeyDown: function (e) {
    if (e.key.toLowerCase() === 'q') {
      this.following = !this.following; 
      if (!this.following && !this.isPlayingTempAnim) {
        this.setRabootAni('pm0955_00_00_00000_defaultwait01_loop', true); 
      }
    }

    if (e.key.toLowerCase() === 'e') {
      this.tryInteract();
    }
  },

  tryInteract: function () {
    const playerPosition = new THREE.Vector3().copy(this.player.object3D.position);
    const rabootPosition = new THREE.Vector3().copy(this.raboot.object3D.position);

    const distance = playerPosition.distanceTo(rabootPosition);

    if (distance <= this.data.interactDistance && !this.isPlayingTempAnim) {

      this.isPlayingTempAnim = true;

      this.raboot.setAttribute('animation-mixer',{time:0});
      this.setRabootAni('pm0955_00_00_00550_glad01', false);

      
      setTimeout(() => {
        this.isPlayingTempAnim = false;

        if (this.following) {
          this.setRabootAni('pm0955_00_00_00030_walk01_loop', true);
          this.isWalking = true;
        } else {
          this.setRabootAni('pm0955_00_00_00000_defaultwait01_loop', true);
          this.isWalking = false;
        }
      }, 2000);
    }
  },

  setRabootAni: function (clipName, loop) {

    this.raboot.removeAttribute('animation-mixer');

    this.raboot.setAttribute('animation-mixer', {
      clip: clipName,
      loop: loop ? 'repeat' : 'once',
      crossFadeDuration: 0.3
    });
  },

  tick: function () {
    if (!this.following || this.isPlayingTempAnim) return;

    const playerPosition = new THREE.Vector3().copy(this.player.object3D.position);
    const rabootPosition = new THREE.Vector3().copy(this.raboot.object3D.position);

    playerPosition.y = this.groundY;
    rabootPosition.y = this.groundY;

    const direction = playerPosition.clone().sub(rabootPosition);
    const distance = direction.length();

    if (distance > 1.5) {
      if (!this.isWalking) {
        this.setRabootAni('pm0955_00_00_00030_walk01_loop', true);
        this.isWalking = true;
      }

      direction.normalize();
      rabootPosition.lerp(playerPosition, 0.01);
      rabootPosition.y = this.groundY;
      this.raboot.object3D.position.copy(rabootPosition);

      this.raboot.object3D.lookAt(playerPosition.x, this.groundY, playerPosition.z);
    } else {
      if (this.isWalking) {
        this.setRabootAni('pm0955_00_00_00000_defaultwait01_loop', true);
        this.isWalking = false;
      }
    }
  }
});

AFRAME.registerComponent('dragapult-interaction', {
  schema: {
    interactDistance: { type: 'number', default: 5 } 
  },

  init: function () {
    this.cyclizar = document.querySelector('#ycyclizar');
    this.rig = document.querySelector('#rig');

    
    this.cyclizar.addEventListener('model-loaded', () => {
      const clips = this.cyclizar.getObject3D('mesh').animations;
    });

    window.addEventListener('keydown', (e) => this.onKeyDown(e));
    this.isRoaring = false;
  },

  onKeyDown: function (e) {
    if (e.key.toLowerCase() === 'e' && !this.isRoaring) {
      const playerPos = new THREE.Vector3().copy(this.rig.object3D.position);
      const cyclizarPos = new THREE.Vector3().copy(this.cyclizar.object3D.position);
      const distance = playerPos.distanceTo(cyclizarPos);

      if (distance <= this.data.interactDistance) {
        this.isRoaring = true;

        this.cyclizar.removeAttribute('animation-mixer');
        
        this.cyclizar.setAttribute('animation-mixer', {
          clip: 'Armature|Armature|pm0887_00_00_ba02_roar01|Base Layer',
          loop: 'once',
          crossFadeDuration: 0.3
        });

        
        setTimeout(() => {
          this.cyclizar.setAttribute('animation-mixer', {
            clip: 'Armature|Armature|pm0887_00_00_ba10_waitA01|Base Layer',
            loop: 'repeat',
            crossFadeDuration: 0.3
          });
          this.isRoaring = false;
        }, 2000);
      }
    }
  }
});

AFRAME.registerComponent('sit-button', {
  init: function () {
    const button = this.el;
    const rig = document.querySelector('#rig');
    const campfire = document.querySelector('#campfire');
    const camera = rig.querySelector('[camera]');
    let isSitting = false;

   
    button.addEventListener('click', () => toggleSit());

    function toggleSit() {
      if (!isSitting) {
        
        rig.setAttribute('position', {
          x: -10,
          y: 0.9,
          z: 13.5
        });

       
        const rigPos = new THREE.Vector3().copy(rig.object3D.position);
        const campfirePos = new THREE.Vector3().copy(campfire.object3D.position);
        const direction = new THREE.Vector3().subVectors(campfirePos, rigPos);
        const rotationY = Math.atan2(direction.x, direction.z) * (180 / Math.PI);
        rig.setAttribute('rotation', { x: 0, y: rotationY, z: 0 });

        
        rig.setAttribute('movement-controls','enabled',false);
      } else {
        
        rig.setAttribute('position', {
          x: rig.object3D.position.x,
          y: 1.6,
          z: rig.object3D.position.z
        });

        
        rig.setAttribute('movement-controls', 'enabled', true);
      }
      isSitting = !isSitting;
    }
  }
});


AFRAME.registerComponent('proximity-spawner', {
  schema: {
    model: { type: 'string' },
    count: { type: 'int', default: 30 },
    radius: { type: 'number', default: 50 },
    scaleMin: { type: 'number', default: 0.3 },
    scaleMax: { type: 'number', default: 0.6 },
    emissive: { type: 'string', default: '' },
    colors: { type: 'array', default: ['red','blue','yellow','purple','orange','green'] }
  },

  init: function () {
    this.player = document.querySelector('[camera]');
    this.objects = [];
    this.spawnPositions = [];

   
    for (let i = 0; i < this.data.count; i++) {
      this.spawnPositions.push({
        x: (Math.random() - 0.5) * 300,
        z: (Math.random() - 0.5) * 300,
        spawned: false
      });
    }
  },

  tick: function () {
    const playerPos = this.player.object3D.position;

    this.spawnPositions.forEach(pos => {
      const dist = playerPos.distanceTo(new THREE.Vector3(pos.x, 0, pos.z));

      if (dist < this.data.radius && !pos.spawned) {
        this.spawnObject(pos);
        pos.spawned = true;
      } else if (dist > this.data.radius + 20 && pos.spawned) {
        this.removeObject(pos);
        pos.spawned = false;
      }
    });
  },

  spawnObject: function (pos) {
    const obj = document.createElement('a-entity');
    obj.setAttribute('gltf-model', this.data.model);
    obj.setAttribute('position', `${pos.x} 0 ${pos.z}`);

    const scale = this.data.scaleMin + Math.random() * (this.data.scaleMax - this.data.scaleMin);
    obj.setAttribute('scale', `${scale} ${scale} ${scale}`);

    const color = this.data.colors[Math.floor(Math.random() * this.data.colors.length)];

    obj.addEventListener('model-loaded', () => {
      obj.getObject3D('mesh').traverse((node) => {
        if (node.isMesh) {
          if (this.data.colors.length) {
            node.material.color.set(color);
          }
          if (this.data.emissive) {
            node.material.emissive.set(this.data.emissive === 'random' ? color : this.data.emissive);
            node.material.emissiveIntensity = 1.5;
          }
        }
      });
    });

    this.el.appendChild(obj);
    pos.entity = obj;
  },

  removeObject: function (pos) {
    if (pos.entity && pos.entity.parentNode) {
      pos.entity.parentNode.removeChild(pos.entity);
      pos.entity = null;
    }
  }
});

AFRAME.registerComponent('sleep-button', {
  init: function () {
    const button = this.el;
    const fadeScreen = document.querySelector('#fadeScreen');

    button.addEventListener('click', () => {

      
      fadeScreen.removeAttribute('animation__fadein');
      fadeScreen.removeAttribute('animation__fadeout');

      
      fadeScreen.setAttribute('animation__fadein', {
        property: 'material.opacity',
        from: 0,
        to: 1,
        dur: 1500,
        easing: 'easeInOutQuad'
      });

      
      setTimeout(() => {
        fadeScreen.removeAttribute('animation__fadeout');
        fadeScreen.setAttribute('animation__fadeout', {
          property: 'material.opacity',
          from: 1,
          to: 0,
          dur: 1500,
          easing: 'easeInOutQuad'
        });
      }, 3500);
    });
  }
});

AFRAME.registerComponent('rotation-reader', {
  tick: function () {
    const cam = this.el.sceneEl.camera.el;
    const rig = this.el;

    
    rig.object3D.rotation.y = cam.object3D.rotation.y;
  }
});

</script>



</body>
</html>
